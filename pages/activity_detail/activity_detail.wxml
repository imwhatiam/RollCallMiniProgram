<home-button />
<view class="container">
  <view class="header">
    <view wx:if="{{activityCreatorWeixinID===weixinID}}">
      <block wx:if="{{isEditingActivityTitle}}">
        <input class="name-input"
              value="{{activityTitle}}"
              bindinput="handleActivityTitleInput"
              bindblur="saveActivityTitle"
              focus="{{isEditingActivityTitle}}" />
      </block>
      <block wx:else>
        <view class="name-display" bindtap="startEditingActivityTitle">
          {{activityTitle || '点击输入名称'}}
        </view>
      </block>
    </view>
    <view wx:else>
       <view class="name-display">
         {{activityTitle}}
       </view>
    </view>
  </view>

  <view class="activity-list-item">

    <view class="stats-section">
      <view class="stats-left">
        <text class="stat-label">总计: {{totalCount}}</text>
        <text class="stat-label">完成: {{checkedCount}}</text>
        <text class="stat-label">取消: {{deletedCount}}</text>
      </view>
      <view class="stats-right">
        <button class="refresh-btn" bindtap="refreshData">刷新</button>
      </view>
    </view>

    <block wx:for="{{activityItems}}" wx:key="index">
      <view wx:if="{{item.status == 'completed'}}" class="list-item completed">
        <view wx:if="{{item.operator_avatar_url}}" class="avatar-container">
          <image class="operator-avatar" src="{{item.operator_avatar_url}}" mode="aspectFill"></image>
        </view>

        <view wx:if="{{item.operator === weixinID}}">
          <button
            class="complete-btn"
            bindtap="handleUncompleteItem"
            data-index="{{index}}"
          >✓</button>
        </view>

        <text class="item-text">{{index}}, {{item.name}}</text>
      </view>

      <view wx:elif="{{item.status == 'deleted'}}" class="list-item deleted">
        <view wx:if="{{item.operator_avatar_url}}" class="avatar-container">
          <image class="operator-avatar" src="{{item.operator_avatar_url}}" mode="aspectFill"></image>
        </view>
        <text class="item-text">{{index}}, {{item.name}}</text>

        <view wx:if="{{item.operator === weixinID}}" style="display: flex; flex-direction: row;">
          <button
            class="delete-btn"
            bindtap="handleUndeleteItem"
            data-index="{{index}}"
          >x</button>
          <view wx:if="{{activityCreatorWeixinID === weixinID}}">
            <button
              class="delete-btn"
              bindtap="handleDeleteItemCompletely"
              data-index="{{index}}"
              data-name="{{item.name}}"
            >彻底删除</button>
          </view>
        </view>
      </view>

      <view wx:else class="list-item">
        <view wx:if="{{item.operator_avatar_url}}" class="avatar-container">
          <image class="operator-avatar" src="{{item.operator_avatar_url}}" mode="aspectFill"></image>
        </view>
        <button class="complete-btn" bindtap="handleCompleteItem" data-index="{{index}}">完成</button>
        <text class="{{showFullTextIndex===index ? 'item-full-text' : 'item-text'}}" bindlongpress="showFullText" bindtouchend="hideFullText" data-index="{{index}}">{{index}}, {{item.name}}</text>
        <block wx:if="{{showFullTextIndex!==index}}"> <button class="delete-btn" bindtap="handleDeleteItem" data-index="{{index}}">取消</button>
        </block>
      </view>
    </block>
  </view>

  <view wx:if="{{activityCreatorWeixinID===weixinID}}" class="bottom-view">
    <input
      type="text"
      placeholder="请输入新人员/子事项"
      bindinput="handleNewItemInput"
      value="{{newItemName}}"
    />
    <button class="create-save-update-btn" bindtap="addNewItem">添加</button>
  </view>
</view>
